# generate a set of fasta files that will work as reads
# one file (originally generated by usearch -cluster_smallmem) will work as a database
# run usearch global

# start with directory of reverse sequences

# convert each fq to fasta
for i in $(ls *2.fq | cut -f 1 -d '.')
do
grep --no-group-separator -B1 "^+" "${i}.fq" | awk '/+/{gsub(/\+/, ">sequence_" (++count))}1' > "${i}.faa"
done

# replace “sequence_” string in fasta files with file name
for file in *.faa
do
file_name=$(basename "$file" .faa)
sed -i -e "s/>sequence_/>${file_name}_/g" "$file"
done

# take all bases after flank
for file in *.faa
do
awk 'BEGIN { RS = ">" ; FS = "\n" } NR > 1 { header = $1; sequence = $2; idx = index(sequence, "GTTACTTAGTTA"); if (idx) { print ">" header "\n" substr(sequence, idx + 12) } }' "$file" > temp && mv temp "$file"
done


# usearch -cluster_smallmem file
/stor/scratch/Ochman/kristen/usearch_global/filtered_clusters.uc

# extract sequence IDs from cluster file
awk '{print $9}' filtered_clusters.uc | sed 's/;size=.*$//' > seq_ids.txt

# find sequence IDs in the .faa files and get the corresponding sequence
# save to new fasta file (this is the database file)
# this took an hour or so to run
while IFS= read -r line
do
grep -A 1 "^>${line}$" *.faa | awk -F ':' '{ if ($0 ~ />/) {sub(/.*>/, ">", $2); print $2} else if ($0 ~ /-/) {sub(/.*-/, "", $0); print} }' >> sequence_database.fasta
done < seq_ids.txt


# run usearch global
# drive5: usearch -usearch_global reads.fastq -db ESTs.fasta -id 0.9 -blast6out hits.b6 -strand plus -maxaccepts 8 -maxrejects 256
# tautz: usearch10 -usearch_global ${rep}.merged.clean.fa -db BACT_DB.fa -threads 24 -id 0.97 -userout ${rep}.blast -userfields query+target+id+alnlen+mism+opens+qlo+qhi+tlo+thi+ql+tl+evalue+bits+qcov+tcov -notmatched ${rep}.notmatched -strand plus -query_cov 0.9 -maxgaps 5
# combo?
# tried running the below code but the "rep" stuff wasn't working. Used a for loop instead (classic).
# while read -r rep; do; ./usearch -usearch_global ${rep}_2.faa -db sequence_database.fasta -id 0.9 -blast6out ${rep}_hits.b6 -strand plus -query_cov 0.9 -maxgaps 5; done
# this took 2-3 hours to run
for file in *_2.faa
do
./usearch -usearch_global "$file" -db sequence_database.fasta -id 0.9 -blast6out "${file%.faa}_hits.b6" -strand plus -query_cov 0.9 -maxgaps 5
done


# cut -f 2 BL_1_CKDL230008524-1A_H5HLYDSX7_L2_2_hits.b6 | sort | uniq -c
# grep -c string *.b6
# generate count table
cut -f 2 *b6 | sort | uniq -c > count_table.txt
